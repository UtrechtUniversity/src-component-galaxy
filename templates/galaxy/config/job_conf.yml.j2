runners:
  local:
    load: galaxy.jobs.runners.local:LocalJobRunner
    workers: 4
{% if _galaxy_has_pulsar %}
  pulsar:
    load: galaxy.jobs.runners.pulsar:PulsarRESTJobRunner
{% endif %}
execution:
  default: singularity
  environments:
    local:
      runner: local
      env:
        - name: PATH
          action: prepend_to
          value: "{{ galaxy_mutable_data_dir }}/shed_tools:$PATH"
    docker:
      runner: local
      docker_enabled: true
      docker_set_user:
      docker_sudo: false
      container_resolvers: # use defaults

{% if _galaxy_use_interactive_tools %}
    {{ _galaxy_default_dispatcher }}:
      runner: dynamic
      type: python
      function: {{ _galaxy_default_dispatcher }}
{% endif %}

    singularity:
      singularity_volumes: {{ apptainer_volumes | join(',') }}
      runner: local
      singularity_enabled: true
      container_resolvers:
        - type: cached_explicit_singularity
          cache_directory: "{{ galaxy_mutable_data_dir }}/cache/singularity/explicit/"
        - type: cached_mulled_singularity
          cache_directory: "{{ galaxy_mutable_data_dir }}/cache/singularity/mulled/"
        - type: mulled_singularity
          auto_install: False
          cache_directory: "{{ galaxy_mutable_data_dir }}/cache/singularity/mulled/"
        - type: build_mulled_singularity
          auto_install: False
          cache_directory: "{{ galaxy_mutable_data_dir }}/cache/singularity/built/"
      env:
        # Ensuring a consistent collation environment is good for reproducibility.
        - name: LC_ALL
          value: C
        # The cache directory holds the docker containers that get converted
        - name: APPTAINER_CACHEDIR
          value: /tmp/singularity
        # Apptainer uses a temporary directory to build the squashfs filesystem
        - name: APPTAINER_TMPDIR
          value: /tmp

{% if _galaxy_has_pulsar %}
{% for pulsar in _galaxy_pulsar_configs_raw %}
{% set env_name = 'remote_' ~ (pulsar.name | default(pulsar.url | replace('https://', '') | replace('http://', '') | replace('.', '-') | replace('/', '-'))) %}
    {{ env_name }}:
      runner: pulsar
      url: {{ pulsar.url }}
      private_token: {{ pulsar.private_token }}
      dependency_resolution: {{ pulsar.dependency_resolution | default('remote') }}
      manager: {{ pulsar.manager | default('_default_') }}
{% if pulsar.docker_enabled | default(false) | bool %}
      docker_enabled: {{ pulsar.docker_enabled }}
      docker_set_user: {{ pulsar.docker_set_user | default('null') }}
      docker_memory: "{{ pulsar.docker_memory | default('8G') }}"
      singularity_enabled: {{ pulsar.singularity_enabled | default(false) }}
      tmp_dir: {{ pulsar.tmp_dir | default(true) }}
      outputs_to_working_directory: {{ pulsar.outputs_to_working_directory | default(false) }}
{% if pulsar.container_resolvers is defined %}
      container_resolvers:
{% for resolver in pulsar.container_resolvers %}
        - type: {{ resolver.type }}
{% if resolver.require_container is defined %}
          require_container: {{ resolver.require_container }}
{% endif %}
{% endfor %}
{% endif %}
{% if pulsar.container_monitor_command is defined %}
      container_monitor_command: {{ pulsar.container_monitor_command }}
      container_monitor_result: {{ pulsar.container_monitor_result | default('callback') }}
      container_monitor_get_ip_method: {{ pulsar.container_monitor_get_ip_method }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

tools:
  - class: local # these special tools that aren't parameterized for remote execution - expression tools, upload, etc
    environment: local
{% if _galaxy_has_pulsar and _galaxy_pulsar_tool_mappings | length > 0 %}
{% for tool_mapping in _galaxy_pulsar_tool_mappings %}
  - id: {{ tool_mapping.tool_id }}
    environment: {{ tool_mapping.environment }}
{% endfor %}
{% endif %}
