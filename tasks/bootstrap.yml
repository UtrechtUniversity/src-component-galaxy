---
- name: Find Galaxy API localhost server definition
  ansible.builtin.lineinfile:
    path: "{{ _galaxy_nginx_conf }}"
    state: absent
    line: "{{ _galaxy_api_localhost_definition }}"
  check_mode: true
  changed_when: false
  register: galaxy_detect_api_localhost

- name: Find Galaxy API localhost server definition
  ansible.builtin.lineinfile:
    path: "{{ _galaxy_nginx_conf }}"
    insertafter: EOF
    line: "{{ _galaxy_api_localhost_definition }}"
  when: galaxy_detect_api_localhost.found == 0
  register: galaxy_add_api_localhost

- name: Restart nginx
  ansible.builtin.service:
    name: nginx
    state: restarted
  when: galaxy_add_api_localhost.changed

- name: Wait for galaxy server to come up
  ansible.builtin.uri:
    url: "http://localhost/api/version"
  register: galaxy_service_live
  until: "galaxy_service_live.status == 200"
  retries: 30
  delay: 10 # check every 10 seconds for a maximum of 5 minutes

- name: Copy the user management script
  ansible.builtin.copy:
    src: manage_bootstrap_user.py
    dest: "/home/{{ galaxy_user }}"
    owner: "{{ galaxy_user }}"
    group: "{{ galaxy_user }}"
    mode: "750"

- name: Create bootstrap user and api key
  ansible.builtin.command:
    cmd: "{{ galaxy_venv_dir }}/bin/python3 /home/{{ galaxy_user }}/manage_bootstrap_user.py -a {{ galaxy_config.galaxy.bootstrap_admin_api_key }} -g http://localhost -e admin@galaxy"
  register: _galaxy_create_bootstrap_user

- name: Include tasks to install custom tools and workflows
  ansible.builtin.include_tasks: tasks/install_tools.yml

- name: Deactivate the bootstrapped admin user
  ansible.builtin.command:
    cmd: "{{ galaxy_venv_dir }}/bin/python3 /home/{{ galaxy_user }}/manage_bootstrap_user.py -d -a {{ galaxy_config.galaxy.bootstrap_admin_api_key }} -g http://localhost -e admin@galaxy"
